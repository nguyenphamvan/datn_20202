<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Meta Tag -->
    <meta charset="utf-8">
    <!-- Title Tag  -->
    <title>Thanh toán đơn hàng</title>
    <th:block th:include="common/header_tag_common"/>
    <style type="text/css">
        .header .cart-item-list li {
            overflow: hidden;
            border-bottom: 1px solid #e6e6e6;
            padding-bottom: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .header .cart-item-list li .remove {
            position: absolute;
            left: 0;
            bottom: 16px;
            margin-top: -20px;
            height: 20px;
            width: 20px;
            line-height: 18px;
            text-align: center;
            background: #fff;
            color: #222;
            border-radius: 0;
            font-size: 11px;
            border: 1px solid #ededed;
        }

        .header .cart-item-list li .remove:hover {
            background: #222;
            color: #fff !important;
            border-color: transparent;
        }

        .header .cart-item-list .cart-img {
            float: right;
            border: 1px solid #ededed;
            overflow: hidden;
        }

        .header .cart-item-list .cart-img img {
            width: 70px;
            height: 70px;
            border-radius: 0;

        }

        .header .cart-item-list .cart-img:hover img {
            transform: scale(1.09);
        }

        .header .cart-item-list .quantity {
            line-height: 22px;
            font-size: 13px;
            padding-bottom: 30px;
        }

        .header .cart-item-list h4 {
            font-size: 14px;
        }

        .header .cart-item-list h4 a {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .header .cart-item-list h4 a:hover {
            color: #F7941D;
        }


    </style>
    <link rel="stylesheet" th:href="@{/css/custom2.css}">

</head>
<body class="js">

<!-- Header -->
<th:block th:include="common/header"/>
<!--/ End Header -->

<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="bread-inner">
                    <ul class="bread-list">
                        <li><a th:href="@{/}">Trang chủ<i class="ti-arrow-right"></i></a></li>
                        <li class="active"><a th:href="@{/checkout.html}">Thanh toán đơn hàng</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Breadcrumbs -->

<!-- Start Checkout -->
<section class="shop checkout section">
    <div class="container">
        <!-- Form -->
        <form class="form" id="payment">
            <div class="row">
                <div class="col-lg-4 col-12">
                    <div class="checkout-form" style="border: 1px solid #eee; margin-top: 0px; min-height: 430px;">
                        <div class="single-widget">
                            <h2>Thông tin liên hệ</h2>
                            <div class="contact-address" style="margin: 25px 30px;">
                                <div class="title" style="border-bottom: 1px solid rgb(201, 201, 201); display: flex;justify-content: space-between; line-height: 31px; padding-bottom: 10px;">
                                    <span>Địa chỉ nhận hàng</span>
                                    <a class="link" data-toggle="modal" data-target="#addressModal" style="display: inline-block;text-decoration: none;font-size: 13px;color: rgb(13, 92, 182);">Thay đổi</a>
                                </div>
                                <div class="address" style="display: inline-grid; padding-bottom: 10px;">
                                    <span class="name" style="font-size: 15px; font-weight: 700; margin-top: 15px;margin-bottom: 10px;"></span>
                                    <span class="street" style="margin: 0px;color: rgb(120, 120, 120);font-size: 13px;"></span>
                                    <span class="phone"></span>
                                </div>

                                <div class="form-group note">
                                    <label>Ghi chú<span>*</span></label>
                                    <textarea name="note" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <!--/ End Form -->
                    </div>
                </div>
                <div class="col-lg-4 col-12">
                    <div class="order-details" style="margin-top: 0px; min-height: 430px;">
                        <!-- Order Widget -->
                        <div class="single-widget">
                            <h2>SỐ TIỀN THANH TOÁN</h2>
                            <div class="content">
                                <ul>
                                    <li>Tổng các mặt hàng<span id="sub-total" th:utext="${session.subCart}"></span></li>
                                    <li>(+) Phí vận chuyển<span id="ship-fee">0</span></li>
                                    <li>(-) Giảm giá<span id="discount">0</span></li>
                                    <li class="last">Tổng thanh toán
                                        <span id="total-cart" th:utext="${session.subCart}"></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!--/ End Order Widget -->
                        <div class="single-widget">
                            <div style="display: flex; justify-content: space-between">
                                <h2>Mã giảm giá</h2>
                                <a style="margin: auto 30px auto 0px; font-size: 13px; color: rgb(13, 92, 182);" data-toggle="modal" data-target="#discountModal">Dành cho bạn</a>
                            </div>
                            <div class="coupon" style="margin: 30px 30px;display: flex;">
                                <form>
                                    <input name="coupon" placeholder="Nhập mã giảm giá"
                                           style="
                                           margin-right: 10px;
                                            width: 70%;
                                            height: 48px;
                                            color: #333;
                                            padding: 0px 20px;
                                            box-shadow: 0px 0px 5px #0000000a;
                                            border: 1px solid #5a5656;
                                            border-radius: 5px;">
                                    <button class="btn" type="button"
                                            style="height: 48px;
                                            padding: 0px;
                                            width: 30%;
                                            color: #333;
                                            background: #fff;
                                            box-shadow: 0px 0px 5px #00000012;
                                            border: 1px solid #5a5656;
                                            border-radius: 5px;">Áp dụng
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-12">
                    <div class="header" style="border: 1px solid #eee; margin-top: 0px; min-height: 430px;">
                        <!-- Order Widget -->
                        <div class="single-widget">
                            <h2>Hình thức giao hàng</h2>
                            <div class="content">
                                <div class="checkbox">
                                    <span style="display: block; margin-bottom: 15px;"><input type="radio" name="deliveryMethod" value="standard"> Giao hàng tiêu chuẩn</span>
                                    <span style="display: block; margin-bottom: 15px;"><input type="radio" name="deliveryMethod" value="fast"> Giao hàng trong ngày (nội thành)</span>
                                </div>
                            </div>
                        </div>
                        <!--/ End Order Widget -->
                        <!-- Order Widget -->
                        <div class="single-widget">
                            <h2>Hình thức thanh toán</h2>
                            <div class="content">
                                <div class="checkbox">
                                    <span style="display: block; margin-bottom: 15px;"><input type="radio" name="paymentMethod" value="cod"> Thanh toán khi nhận hàng</span>
                                    <span style="display: block; margin-bottom: 15px;"><input type="radio" name="paymentMethod" value="paypal"> PayPal</span>
                                </div>
                            </div>
                        </div>
                        <!--/ End Order Widget -->
                    </div>
                </div>
            </div>
        </form>
        <div class="group-action-button" style="padding-top: 30px;">
            <!-- Button Widget -->
            <div class="single-widget get-button" style="padding: 0px;">
                <div class="content" style="display: flex;">
                    <div class="button" style="margin-right: 10px;">
                        <button id="payment-order" type="submit">
                            <a class="btn">Tiến hành đặt hàng</a>
                        </button>
                    </div>
                    <div class="button" style="margin-right: 10px;">
                        <button type="submit">
                            <a th:href="@{/cart.html}" class="btn">Xem lại giỏ hàng</a>
                        </button>
                    </div>
                </div>
            </div>
            <!--/ End Button Widget -->
        </div>
    </div>
</section>
<!--/ End Checkout -->

<!-- Start Shop Services Area  -->
<section class="shop-services section home">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-6 col-12">
                <!-- Start Single Service -->
                <div class="single-service">
                    <i class="ti-rocket"></i>
                    <h4>Miễn phí giao hàng</h4>
                    <p>Đơn đặt hàng trên $ 100</p>
                </div>
                <!-- End Single Service -->
            </div>
            <div class="col-lg-3 col-md-6 col-12">
                <!-- Start Single Service -->
                <div class="single-service">
                    <i class="ti-reload"></i>
                    <h4>MIỄN PHÍ ĐỔI TRẢ</h4>
                    <p>Trong vòng 30 ngày trở lại</p>
                </div>
                <!-- End Single Service -->
            </div>
            <div class="col-lg-3 col-md-6 col-12">
                <!-- Start Single Service -->
                <div class="single-service">
                    <i class="ti-lock"></i>
                    <h4>BẢO MẬT THANH TOÁN</h4>
                    <p>Thanh toán an toàn 100%</p>
                </div>
                <!-- End Single Service -->
            </div>
            <div class="col-lg-3 col-md-6 col-12">
                <!-- Start Single Service -->
                <div class="single-service">
                    <i class="ti-tag"></i>
                    <h4>GIÁ CẢ TỐT NHẤT</h4>
                    <p>Giá đảm bảo</p>
                </div>
                <!-- End Single Service -->
            </div>
        </div>
    </div>
</section>
<!-- End Shop Services -->

<!-- The Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span class="ti-close" aria-hidden="true"></span></button>
            </div>
            <div class="modal-body">
                <div class="row no-gutters">
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12" style="display: none;">
                        <div class="address-item" style="margin: 20px 50px 20px 20px; border: 1px dashed red; padding: 10px 15px; min-height: 172px; position: relative;">
                            <p class="name" style="text-transform: uppercase;  margin: 0px 0px 10px; font-weight: 500;">
                                <span></span>
                            </p>
                            <p class="address">
                                <span>Địa chỉ: </span> <span></span>
                            </p>
                            <p class="phone">
                                <span>Điện thoại: </span> <span></span>
                            </p>
                            <p class="action" style="position: absolute; bottom: 10px; left: 15px;">
                                <button type="button" class="btn saving-address">Giao đến địa chỉ này</button>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- The Modal -->
<div class="modal fade" id="discountModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                Mã giảm giá dành cho đơn hàng
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span class="ti-close" aria-hidden="true"></span></button>
            </div>
            <div class="modal-body">
                <div class="row no-gutters">
                    <div class="col-lg-6 col-md-12 col-sm-12 col-xs-12" style="display: none;">
                        <div class="discount-item" style="margin: 20px 50px 20px 20px; border: 1px dashed red; padding: 10px 15px; min-height: 172px; position: relative;">
                            <p class="title" style="margin: 0px 0px 10px; font-weight: 500;">
                                <span></span>
                            </p>
                            <p class="code">
                                <span>Mã giảm giá: </span> <span></span>
                            </p>
                            <p class="end-date">
                                <span>Ngày hết hạn: </span> <span></span>
                            </p>
                            <p class="action" style="position: absolute; bottom: 10px; left: 15px;">
                                <button type="button" class="btn apply-coupon">Áp dụng</button>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Start Footer Area -->
<th:block th:include="common/footer"/>
<!-- /End Footer Area -->

<script th:inline="javascript">
    /*<![CDATA[*/
    // A $( document ).ready() block.
    $(document).ready(function () {

        getInfoPayment();
        getTheShippingAddress();
        getDiscountForOrder();

        $(".coupon button").on("click", function () {
            let couponCode = $(".coupon input[name='coupon']").val();
            if (couponCode === "") {
                $(".coupon").after("<div class='error-msg' style='color: red; margin: 0px 30px;'>Bạn chưa nhập mã giảm giá</div>")
            } else {
                let data = {"couponCode" : couponCode}
                applyCoupon(data);
            }
        });

        $(".shop.checkout .single-widget.get-button #payment-order").on("click", function (e){
            e.preventDefault();
            payment();
        });

        $("input[name='deliveryMethod']").on("click", function () {
            if ($(this).val() === "fast") {
                $("span#ship-fee").text("200");
            } else if ($(this).val() === "standard") {
                $("span#ship-fee").text("100");
            }
            let subTotal = $("span#sub-total").text();
            let discount = $("span#discount").text();
            let shipFee = $("span#ship-fee").text();
            $("span#total-cart").text(parseInt(subTotal) + parseInt(shipFee) - parseInt(discount));
        });

        $(document).on("click", "#addressModal > div > div > div.modal-body > div > div > div > p.action", function () {
            let receiver = $(this).closest("div.address-item").find("p.name > span:nth-child(1)").text();
            let address = $(this).closest("div.address-item").find("p.address > span:nth-child(2)").text();
            let phone = $(this).closest("div.address-item").find("p.phone > span:nth-child(2)").text();
            $(".contact-address .address .name").text(receiver);
            $(".contact-address .address .street").text(address);
            $(".contact-address .address .phone").text("Điện thoại : " + phone);
            $('#addressModal').modal('hide');
        });

        $(document).on("click", "#discountModal > div > div > div.modal-body > div > div > div > p.action", function () {
            let couponCode = $(this).closest("div.discount-item").find("p.code > span:nth-child(2)").text();
            $("#payment > div > div:nth-child(2) > div > div:nth-child(2) > div.coupon > input").val(couponCode);
            $('#discountModal').modal('hide');
        });
    });

    function applyCoupon(couponCode) {
        $.ajax({
            url: "/api/checkout/apply-couponCode",
            type: "POST",
            data: JSON.stringify(couponCode),
            dataType: 'json',
            contentType: 'application/json',
            success: function (order) {
                $(".error-msg").remove();
                alert("Mã giảm giá đã được áp dụng");
                $(".order-details ul").empty();
                $(".order-details ul").append(
                    "<li>Tổng các mặt hàng<span id=\"sub-total\">" + order["subTotal"] + "</span></li>\n" +
                    "<li>(+) Phí vận chuyển<span id=\"ship-fee\">" + order["shipFee"] + "</span></li>\n" +
                    "<li>(-) Giảm giá<span id=\"discount\">" + order["discount"] + "</span></li>\n" +
                    "<li class=\"last\">Tổng thanh toán\n" +
                    "    <span id=\"total-cart\">" + order["total"] + "</span>\n" +
                    "</li>"
                )
            },
            error: function (xhr) {
                $(".coupon").after("<div class='error-msg' style='color: red; margin: 0px 30px;'>" + xhr.responseText + "</div>");
            }
        });
    }

    function getInfoPayment() {
        $.ajax({
            url: "/api/checkout/getInfo",
            type: "GET",
            contentType: "application/json",
            success: function (data) {

                // show category
                let categories = data["categories"];
                let html = "";
                $.each(categories, function( index, item ) {
                    html += "<li>\n" +
                        "            <a class=\"parent-category\" href='/collections.html?category=" + item["categoryUrl"] + "'>" + item["categoryName"] + "</a>\n" +
                        "            <ul class=\"list-child-category\">\n";
                    if (item.hasOwnProperty("subCategory")) {
                        $.each(item["subCategory"], function( index, subItem ) {
                            html += "<li>\n" +
                                "         <a href='/collections.html?category=" + subItem["categoryUrl"] + "'>" + subItem["categoryName"] + "</a>\n" +
                                "    </li>\n";
                        });
                    }
                    html += "     </ul>\n" +
                        "</li>";

                });
                $("div.header-inner > div > div > div > div > div > nav > div > div > ul > li:nth-child(2) > ul").append(html);

                let order = data["order"]
                $(".contact-address .address .name").text(order["shippingAddress"]["contactReceiver"]);
                $(".contact-address .address .street").text(order["shippingAddress"]["contactAddress"]);
                $(".contact-address .address .phone").text("Điện thoại : " + order["shippingAddress"]["contactPhone"]);
                $(".shop.checkout .single-widget .content ul li span[id=\"sub-total\"]").text(order["subTotal"]);
                $(".shop.checkout .single-widget .content ul li span[id=\"discount\"]").text(order["discount"]);
                $(".shop.checkout .single-widget .content ul li span[id=\"ship-fee\"]").text(order["shipFee"]);
                $(".shop.checkout .single-widget .content ul li span[id=\"total-cart\"]").text(order["total"]);
                $("input[name='deliveryMethod']").each(function () {
                    if ($(this).val() === order["deliveryMethod"]) {
                        $(this).prop('checked', true);
                    }
                });
                $("input[name='paymentMethod']").each(function () {
                    if ($(this).val() === order["paymentMethod"]) {
                        $(this).prop('checked', true);
                    }
                });
            },
            error: function (xhr) {
                alert(xhr.responseText);
            }
        });
    }

    function payment() {
        let data = {
            "shippingAddress": {
                "contactReceiver": $(".contact-address .address .name").text(),
                "contactPhone": $(".contact-address .address .phone").text().replace("Điện thoại : "),
                "contactAddress": $(".contact-address .address .street").text()
            },
            "note": $("form[id='payment']").find("textarea").val(),
            "subTotal": $(".shop.checkout .single-widget .content ul li span[id=\"sub-total\"]").text(),
            "discount": $(".shop.checkout .single-widget .content ul li span[id=\"discount\"]").text(),
            "shipFee": $(".shop.checkout .single-widget .content ul li span[id=\"ship-fee\"]").text(),
            "total": $(".shop.checkout .single-widget .content ul li span[id=\"total-cart\"]").text(),
            "paymentMethod": $("input[name='paymentMethod']:checked").val(),
            "deliveryMethod": $("input[name='deliveryMethod']:checked").val()
        }
        $.ajax({
            url: "/api/checkout/payment",
            type: "POST",
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            success: function (message) {
                alert(message);
                window.location.replace("/");
            },
            error: function (xhr) {
                alert(xhr.responseText);
            }
        });
    }

    function getTheShippingAddress() {
        $.ajax({
            url: "/api/account/address",
            type: "GET",
            dataType: 'json',
            contentType: "application/json",
            success: function (data) {
                let infoShippingAddress = data["shippingAddr"];
                let firstDivAddr = $("#addressModal > div > div > div.modal-body > div > div:nth-child(1)");
                $.each(infoShippingAddress, function( index, item ) {
                    let itemClone = firstDivAddr.clone();
                    itemClone.show();
                    itemClone.attr("isDefault", item["default"]);
                    itemClone.find("p.name > span:nth-child(1)").text(item["contactReceiver"]);
                    if (item["default"] === true) {
                        itemClone.find("p.name > span:nth-child(1)").after("<span style=\"margin: 0px 0px 0px 15px; color: rgb(38, 188, 78);\">\n" +
                            "                                        <svg stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" viewBox=\"0 0 512 512\" height=\"1em\" width=\"1em\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                            "                                            <path d=\"M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 48c110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200-110.532 0-200-89.451-200-200 0-110.532 89.451-200 200-200m140.204 130.267l-22.536-22.718c-4.667-4.705-12.265-4.736-16.97-.068L215.346 303.697l-59.792-60.277c-4.667-4.705-12.265-4.736-16.97-.069l-22.719 22.536c-4.705 4.667-4.736 12.265-.068 16.971l90.781 91.516c4.667 4.705 12.265 4.736 16.97.068l172.589-171.204c4.704-4.668 4.734-12.266.067-16.971z\"></path>\n" +
                            "                                        </svg>\n" +
                            "                                        <span>Địa chỉ mặc định</span>\n" +
                            "                                    </span>");
                        itemClone.find("p.action > button.saving-address").css("color", "rgb(38, 188, 78);");
                    }
                    itemClone.find("p.address > span:nth-child(2)").text(item["contactAddress"]);
                    itemClone.find("p.phone > span:nth-child(2)").text(item["contactPhone"]);
                    itemClone.insertAfter(firstDivAddr);
                });
                firstDivAddr.hide();
            },
            error: function () {
                alert("có lỗi xảy ra, không lấy được danh sách địa chỉ giao hàng");
            }
        });
    }

    function getDiscountForOrder() {
        $.ajax({
            url: "/api/checkout/getMyDiscount",
            type: "GET",
            contentType: "application/json",
            success: function (data) {
                let firstItem = $("#discountModal > div > div > div.modal-body > div > div:nth-child(1)");
                $.each(data, function( index, item ) {
                    let itemClone = firstItem.clone();
                    itemClone.show();
                    itemClone.find("p.title > span:nth-child(1)").text(item["title"]);
                    itemClone.find("p.code > span:nth-child(2)").text(item["code"]);
                    itemClone.find("p.end-date > span:nth-child(2)").text(item["endDate"]);
                    itemClone.insertAfter(firstItem);
                });
                firstItem.hide();
            },
            error: function () {
                alert("có lỗi xảy ra, không lấy được danh sách mã giảm giá cho bạn");
            }
        });
    }

    function getListCategory() {
        $.ajax({
            url: "/api/categories",
            type: "GET",
            contentType: "application/json",
            success: function (categories) {
                // show category
                let html = "";
                $.each(categories, function( index, item ) {
                    html += "<li>\n" +
                        "            <a class=\"parent-category\" href='/collections.html?category=" + item["categoryUrl"] + "'>" + item["categoryName"] + "</a>\n" +
                        "            <ul class=\"list-child-category\">\n";
                    if (item.hasOwnProperty("subCategory")) {
                        $.each(item["subCategory"], function( index, subItem ) {
                            html += "<li>\n" +
                                "         <a href='/collections.html?category=" + subItem["categoryUrl"] + "'>" + subItem["categoryName"] + "</a>\n" +
                                "    </li>\n";
                        });
                    }
                    html += "     </ul>\n" +
                        "</li>";

                });
                $("div.header-inner > div > div > div > div > div > nav > div > div > ul > li:nth-child(2) > ul").append(html);

            },
            error: function () {
                alert("có lỗi xảy ra, không lấy được danh sách danh mục");
            }
        });
    }
    /*]]>*/
</script>
</body>
</html>