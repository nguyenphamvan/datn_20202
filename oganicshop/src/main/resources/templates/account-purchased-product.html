<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Sản phẩm đã mua</title>
    <th:block th:include="common/header_tag_common"/>
    <!-- custom css  -->
    <link rel="stylesheet" th:href="@{/css/custom2.css}">
</head>
<body class="js">
<!-- Header -->
<th:block th:include="common/header"/>
<!--/ End Header -->

<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="bread-inner">
                    <ul class="bread-list">
                        <li><a th:href="@{/}">Trang chủ<i class="ti-arrow-right"></i></a></li>
                        <li class="active">Thông tin tài khoản</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Breadcrumbs -->

<!-- Product Style -->
<section class="product-area shop-sidebar shop section" style="padding-top: 15px;">
    <div class="container">
        <div class="row">
            <div class="Account__StyledSideBar">
                <div class="Account__StyledAvatar">
                    <img src="https://salt.tikicdn.com/desktop/img/avatar.png">
                    <div th:if="${#request.userPrincipal}" class="info">Tài khoản của<strong sec:authentication="principal.fullName"></strong></div>
                </div>
                <ul class="Account__StyledNav">
                    <li>
                        <a class="" href="/customer/account/edit">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                            </svg>
                            <span>Thông tin tài khoản</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/notification">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path>
                            </svg>
                            <span>Thông báo của tôi</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/sales/order/history">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 12h7v1.5h-7zm0-2.5h7V11h-7zm0 5h7V16h-7zM21 4H3c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 15h-9V6h9v13z"></path>
                            </svg>
                            <span>Quản lý đơn hàng</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/address">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path>
                            </svg>
                            <span>Địa chỉ giao hàng</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/nhan-xet-san-pham-ban-da-mua">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"></path>
                            </svg>
                            <span>Nhận xét sản phẩm đã mua</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/wishlist">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                            </svg>
                            <span>Sản phẩm yêu thích</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/review">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"></path>
                            </svg>
                            <span>Nhận xét của tôi</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="Account__StyledAccountLayoutInner" id="post_review">
                <div class="style__StyledMyReviews">
                    <div class="my-reviews__heading">Nhận xét sản phẩm đã mua</div>
                    <div class="my-reviews__inner">
                        <a class="my-reviews__item">
                            <div class="my-reviews__info">
                                <img>
                                <div class="my-reviews__name"></div>
                            </div>
                            <button class="my-reviews__button" data-toggle="modal" data-target="#myModal">Viết nhận xét
                            </button>
                        </a>
                    </div>
                </div>
            </div>
            <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-label="Viết nhận xét"
                 style="inset: 50% auto auto 50%; transform: translate(-50%, -50%);">
                <div class="style__StyledWriteReview write-review">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <form class="write-review__inner" enctype="multipart/form-data">
                        <input name="orderDetail-id" type="hidden">
                        <input name="product-id" type="hidden">
                        <div class="write-review__product">
                            <img class="write-review__product-img">
                            <div class="write-review__product-wrap">
                                <div class="write-review__product-name"></div>
                            </div>
                        </div>
                        <div class="write-review__heading">Vui lòng đánh giá</div>
                        <div class="write-review__stars">
							<span class="write-review__star" data-rating-value="1">
								<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 32 32">
									<path fill="none" fill-rule="evenodd" stroke="#FFB500" stroke-width="1.5"
                                          d="M16 1.695l-4.204 8.518-9.401 1.366 6.802 6.631-1.605 9.363L16 23.153l8.408 4.42-1.605-9.363 6.802-6.63-9.4-1.367L16 1.695z"></path>
								</svg>
							</span>
                            <span class="write-review__star" data-rating-value="2">
								<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 32 32">
									<path fill="none" fill-rule="evenodd" stroke="#FFB500" stroke-width="1.5"
                                          d="M16 1.695l-4.204 8.518-9.401 1.366 6.802 6.631-1.605 9.363L16 23.153l8.408 4.42-1.605-9.363 6.802-6.63-9.4-1.367L16 1.695z"></path>
                                </svg>
                            </span>
                            <span class="write-review__star" data-rating-value="3">
								<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 32 32">
									<path fill="none" fill-rule="evenodd" stroke="#FFB500" stroke-width="1.5"
                                          d="M16 1.695l-4.204 8.518-9.401 1.366 6.802 6.631-1.605 9.363L16 23.153l8.408 4.42-1.605-9.363 6.802-6.63-9.4-1.367L16 1.695z"></path>
								</svg>
							</span>
                            <span class="write-review__star" data-rating-value="4">
								<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 32 32">
									<path fill="none" fill-rule="evenodd" stroke="#FFB500" stroke-width="1.5"
                                          d="M16 1.695l-4.204 8.518-9.401 1.366 6.802 6.631-1.605 9.363L16 23.153l8.408 4.42-1.605-9.363 6.802-6.63-9.4-1.367L16 1.695z"></path>
								</svg>
							</span>
                            <span class="write-review__star" data-rating-value="5">
								<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 32 32">
									<path fill="none" fill-rule="evenodd" stroke="#FFB500" stroke-width="1.5"
                                          d="M16 1.695l-4.204 8.518-9.401 1.366 6.802 6.631-1.605 9.363L16 23.153l8.408 4.42-1.605-9.363 6.802-6.63-9.4-1.367L16 1.695z"></path>
								</svg>
							</span>
                            <input name="rating-value" type="hidden">
                        </div>
                        <textarea rows="8" class="write-review__input"></textarea>
                        <div class="write-review__buttons">
                            <input class="write-review__file" type="file" multiple="">
                            <button type="button" class="write-review__button write-review__button--image"
                                    style="border: 1px solid rgb(13, 92, 182); color: rgb(13, 92, 182);">
                                <img src="https://salt.tikicdn.com/ts/upload/ad/f9/bf/79e0539a981e363ba6ac5bfeef3c70da.png"><span>Thêm ảnh</span>
                                <input type="file" name="upload" class="upload__file--button"
                                       accept="image/png, image/jpeg">
                            </button>
                            <button id="btn-post-review" type="button"
                                    class="write-review__button write-review__button--submit" style="background-color: rgb(253, 216, 53);
								color: rgb(36, 36, 36);">
                                <span>Gửi đánh giá</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<!--/ End Product Style 1  -->

<!-- Start Footer Area -->
<th:block th:include="common/footer"/>
<!-- /End Footer Area -->

<script th:inline="javascript">
    /*<![CDATA[*/
    // A $( document ).ready() block.
    $(document).ready(function () {
        getListProductIsNotReviewed();

        $("#btn-post-review").on("click", function () {
            let data = new FormData();
            let orderDetailId = $("input[name='orderDetail-id']").val();
            let productId = $("input[name='product-id']").val();
            let title = $(".write-review__heading").text();
            let comment = $("textarea.write-review__input").val();
            let rating = $("input[name='rating-value']").val();
            let imageFile = $("input[name='upload']")[0].files[0];
            data.append("title", title);
            data.append("comment", comment);
            data.append("rating", rating);
            data.append("productId", productId);
            data.append("orderDetailId", orderDetailId);
            data.append('image', imageFile);
            $.ajax({
                url: "/api/review/post",
                data: data,
                type: "POST",
                enctype: 'multipart/form-data',
                // prevent jQuery from automatically transforming the data into a query string
                processData: false,
                contentType: false,
                cache: false,
                timeout: 1000000,
                success: function (result) {
                    $("#myModal").modal('hide');
                    ;
                    alert(result);
                    getListProductIsNotReviewed();
                },
                error: function () {
                    alert("có lỗi xảy ra");
                }
            });
        })

        $(document).on('click', '.my-reviews__button', function (e) {
            e.preventDefault();
            $(".write-review__product img").attr("src", $(this).siblings(".my-reviews__info").find("img").attr("src"));
            $(".write-review__product-name").text($(this).siblings(".my-reviews__info").find(".my-reviews__name").text());
            $("input[name='orderDetail-id']").val($(this).siblings(".my-reviews__info").attr("orderDetail-id"));
            $("input[name='product-id']").val($(this).siblings(".my-reviews__info").attr("product-id"));
        });

        var isClickStarRating = false;
        $('.write-review__star > svg').hover(
            function () {
                if (!isClickStarRating) {
                    let ratingValue = $(this).parent().data('rating-value');
                    if (ratingValue === 1) {
                        $(".write-review__heading").text("Rất không hài lòng");
                    } else if (ratingValue === 2) {
                        $(".write-review__heading").text("Không hài lòng");
                    } else if (ratingValue === 3) {
                        $(".write-review__heading").text("Bình thường");
                    } else if (ratingValue === 4) {
                        $(".write-review__heading").text("Hài lòng");
                    } else {
                        $(".write-review__heading").text("Rất hài lòng");
                    }
                    $(this).find('path').siblings().attr('fill', 'none');
                    $(this).find('path').attr('fill', '#FDD835');
                    $(this).parent().prevAll().find('path').attr('fill', '#FDD835');
                    $(this).parent().nextAll().find('path').attr('fill', 'none');
                }
            },
            function () {
                if (!isClickStarRating) {
                    $(".write-review__heading").text("Vui lòng đánh giá");
                    $(this).find('path').attr('fill', 'none');
                    $(this).parent().prevAll().find('path').attr('fill', 'none');
                    $(this).parent().nextAll().find('path').attr('fill', 'none');
                }
            }
        );

        $('.write-review__star > svg').on('click', function () {
            isClickStarRating = true;
            let ratingValue = $(this).parent().data('rating-value');
            if (ratingValue === 1) {
                $(".write-review__heading").text("Rất không hài lòng");
            } else if (ratingValue === 2) {
                $(".write-review__heading").text("Không hài lòng");
            } else if (ratingValue === 3) {
                $(".write-review__heading").text("Bình thường");
            } else if (ratingValue === 4) {
                $(".write-review__heading").text("Hài lòng");
            } else {
                $(".write-review__heading").text("Rất hài lòng");
            }
            $(this).find('path').siblings().attr('fill', 'none');
            $(this).find('path').attr('fill', '#FDD835');
            $(this).parent().prevAll().find('path').attr('fill', '#FDD835');
            $(this).parent().nextAll().find('path').attr('fill', 'none');
            $("input[name='rating-value']").val(ratingValue);
        });
    });

    function getListProductIsNotReviewed() {
        $.ajax({
            url: "/api/sales/order/product-not-reviewed",
            type: "GET",
            dataType: 'json',
            success: function (listItem) {
                if (listItem.length > 0) {
                    let firstItem = $(".my-reviews__inner a:first-child");
                    $.each(listItem, function (index, item) {
                        let itemClone = firstItem.clone();
                        itemClone.attr("href", "/products/" + item["productUrl"] + ".html");
                        itemClone.find("div.my-reviews__info").attr("product-id", item["productId"]).attr("orderDetail-id", item["id"]);
                        itemClone.find("img").attr("src", "/images/products/" + item["image"]).attr("alt", item["productName"]);
                        itemClone.find("div.my-reviews__name").text(item["productUrl"]);
                        itemClone.insertAfter(".my-reviews__inner a:first-child");
                    });
                    firstItem.hide();
                } else {
                    $(".style__StyledMyReviews").empty()
                        .append("<div style='text-align: center; padding: 50px;'><a href='/'><button class='btn-info'>Tiếp tục muc sắm</button></a></div>")
                }
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
    }

    /*]]>*/
</script>
</body>
</html>