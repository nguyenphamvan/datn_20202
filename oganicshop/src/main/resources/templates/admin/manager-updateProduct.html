<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<th:block th:include="admin/common/header"/>
<head>
    <title>Cập nhật sản phẩm</title>
    <style>
        label {
            color: black !important;
            font-weight: 500 !important;
        }
    </style>
</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Admin</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
            <a class="nav-link" th:href="@{/admin}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item active">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-cog"></i>
                <span>Quản lý</span>
            </a>
            <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" th:href="@{/admin/manager_users}"><i class="fas fa-users"></i> Quản lý người dùng</a>
                    <a class="collapse-item active" th:href="@{/admin/manager_products}"><i class="fab fa-product-hunt"></i> Quản lý sản phẩm</a>
                    <a class="collapse-item" th:href="@{/admin/manager_orders}"><i class="fas fa-shopping-basket"></i> Quản lý đơn hàng</a>
                    <a class="collapse-item" th:href="@{/admin/manager_promotions}"><i class="fa fa-gift"></i> Quản lý khuyến mãi</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" data-toggle="collapse" data-target="#collapseThree"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-user-circle"></i>
                <span>Tài khoản</span>
            </a>
            <div id="collapseThree" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item"><i class="fas fa-users"></i>Cập nhật thông tin</a>
                    <form name="logoutForm" th:hidden="true" method="post" th:action="@{/admin/logout}">
                        <input type="submit" value="Logout" />
                    </form>
                    <a class="collapse-item" href="javascript: logoutForm.submit();"><i class="fab fa-product-hunt"></i> <span>Đăng xuất</span></a>
                </div>
            </div>
        </li>

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>

    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <!-- Sidebar Toggle (Topbar) -->
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>

                <div class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                    <h1 class="h3 mb-0 text-body" style="color: black!important;">Cập nhật thông tin sản phẩm</h1>
                </div>

                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span th:text="${#request.userPrincipal.principal.getFullName()}"
                                  class="mr-2 d-none d-lg-inline text-gray-600 small"></span>
                            <img class="img-profile rounded-circle" src="https://source.unsplash.com/QAB-WJcbgJk/60x60">
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- End of Topbar -->

            <!-- Begin Page Content -->
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <form id="formUpdateProduct" enctype="multipart/form-data">
                            <input type="hidden" class="form-control" id="productId" name="id">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="productName">Tên sản phẩm:</label>
                                        <input type="text" class="form-control" placeholder="Nhập tên sản phẩm" id="productName" name="name">
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="select-category-supplier">
                                <div class="col-md-4">
                                    <label for="category">Danh mục</label>
                                    <select class="form-control" id="category" name="parentCategoryId">
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="author">Tác giả</label>
                                    <input class="form-control" id="author" name="author" placeholder="Nhập tên tác giả">
                                </div>
                                <div class="col-md-4">
                                    <label for="publishih_year">Năm xuất bản:</label>
                                    <select class="form-control" id="publishih_year" name="publishih_year">
                                        <option value="">Year</option>
                                        <option value="2012">2021</option>
                                        <option value="2011">2020</option>
                                        <option value="2012">2019</option>
                                        <option value="2011">2018</option>
                                        <option value="2010">2017</option>
                                        <option value="2009">2016</option>
                                        <option value="2008">2015</option>
                                        <option value="2007">2014</option>
                                        <option value="2006">2013</option>
                                        <option value="2012">2012</option>
                                        <option value="2011">2011</option>
                                        <option value="2010">2010</option>
                                        <option value="2009">2009</option>
                                        <option value="2008">2008</option>
                                        <option value="2007">2007</option>
                                        <option value="2006">2006</option>
                                        <option value="2005">2005</option>
                                        <option value="2004">2004</option>
                                        <option value="2003">2003</option>
                                        <option value="2002">2002</option>
                                        <option value="2001">2001</option>
                                        <option value="2000">2000</option>
                                        <option value="1999">1999</option>
                                        <option value="1998">1998</option>
                                        <option value="1997">1997</option>
                                        <option value="1996">1996</option>
                                        <option value="1995">1995</option>
                                        <option value="1994">1994</option>
                                        <option value="1993">1993</option>
                                        <option value="1992">1992</option>
                                        <option value="1991">1991</option>
                                        <option value="1990">1990</option>
                                        <option value="1989">1989</option>
                                        <option value="1988">1988</option>
                                        <option value="1987">1987</option>
                                        <option value="1986">1986</option>
                                        <option value="1985">1985</option>
                                        <option value="1984">1984</option>
                                        <option value="1983">1983</option>
                                        <option value="1982">1982</option>
                                        <option value="1981">1981</option>
                                        <option value="1980">1980</option>
                                        <option value="1979">1979</option>
                                        <option value="1978">1978</option>
                                        <option value="1977">1977</option>
                                        <option value="1976">1976</option>
                                        <option value="1975">1975</option>
                                        <option value="1974">1974</option>
                                        <option value="1973">1973</option>
                                        <option value="1972">1972</option>
                                        <option value="1971">1971</option>
                                        <option value="1970">1970</option>
                                        <option value="1969">1969</option>
                                        <option value="1968">1968</option>
                                        <option value="1967">1967</option>
                                        <option value="1966">1966</option>
                                        <option value="1965">1965</option>
                                        <option value="1964">1964</option>
                                        <option value="1963">1963</option>
                                        <option value="1962">1962</option>
                                        <option value="1961">1961</option>
                                        <option value="1960">1960</option>
                                        <option value="1959">1959</option>
                                        <option value="1958">1958</option>
                                        <option value="1957">1957</option>
                                        <option value="1956">1956</option>
                                        <option value="1955">1955</option>
                                        <option value="1954">1954</option>
                                        <option value="1953">1953</option>
                                        <option value="1952">1952</option>
                                        <option value="1951">1951</option>
                                        <option value="1950">1950</option>
                                        <option value="1949">1949</option>
                                        <option value="1948">1948</option>
                                        <option value="1947">1947</option>
                                        <option value="1946">1946</option>
                                        <option value="1945">1945</option>
                                        <option value="1944">1944</option>
                                        <option value="1943">1943</option>
                                        <option value="1942">1942</option>
                                        <option value="1941">1941</option>
                                        <option value="1940">1940</option>
                                        <option value="1939">1939</option>
                                        <option value="1938">1938</option>
                                        <option value="1937">1937</option>
                                        <option value="1936">1936</option>
                                        <option value="1935">1935</option>
                                        <option value="1934">1934</option>
                                        <option value="1933">1933</option>
                                        <option value="1932">1932</option>
                                        <option value="1931">1931</option>
                                        <option value="1930">1930</option>
                                        <option value="1929">1929</option>
                                        <option value="1928">1928</option>
                                        <option value="1927">1927</option>
                                        <option value="1926">1926</option>
                                        <option value="1925">1925</option>
                                        <option value="1924">1924</option>
                                        <option value="1923">1923</option>
                                        <option value="1922">1922</option>
                                        <option value="1921">1921</option>
                                        <option value="1920">1920</option>
                                        <option value="1919">1919</option>
                                        <option value="1918">1918</option>
                                        <option value="1917">1917</option>
                                        <option value="1916">1916</option>
                                        <option value="1915">1915</option>
                                        <option value="1914">1914</option>
                                        <option value="1913">1913</option>
                                        <option value="1912">1912</option>
                                        <option value="1911">1911</option>
                                        <option value="1910">1910</option>
                                        <option value="1909">1909</option>
                                        <option value="1908">1908</option>
                                        <option value="1907">1907</option>
                                        <option value="1906">1906</option>
                                        <option value="1905">1905</option>
                                        <option value="1904">1904</option>
                                        <option value="1903">1903</option>
                                        <option value="1902">1902</option>
                                        <option value="1901">1901</option>
                                        <option value="1900">1900</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="price">Giá bán (VNĐ)</label>
                                        <input type="number" class="form-control" placeholder="Nhập giá gốc" id="price"
                                               name="price">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="promotion">Giảm giá(%)</label>
                                        <input type="number" class="form-control" placeholder="giảm giá" id="promotion" name="promotion">
                                    </div>
                                </div>
                            </div>


                            <div class="row">
                                <div class="col-md-6">
                                    <label for="imageUpload1">ảnh 1</label>
                                    <div class="form-group">
                                        <div class="custom-file">
                                            <input type="file" name="images" class="custom-file-input" id="imageUpload1"
                                                   accept="image/*" onchange="loadImage1(event)">
                                            <label class="custom-file-label" for="imageUpload1">Choose file</label>
                                        </div>
                                    </div>
                                    <img id="output1" style="width: 100%; max-height: 400px; margin-top: 10px;"/>
                                </div>
                                <div class="col-md-6">
                                    <label for="imageUpload2">ảnh 2</label>
                                    <div class="form-group">
                                        <div class="custom-file">
                                            <input type="file" name="images" class="custom-file-input" id="imageUpload2"
                                                   accept="image/*" onchange="loadImage2(event)">
                                            <label class="custom-file-label" for="imageUpload2">Choose file</label>
                                        </div>
                                    </div>
                                    <img id="output2" style="width: 100%; max-height: 400px; margin-top: 10px;"/>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="detailDescription">Mô tả chi tiết:</label>
                                        <textarea rows="10" class="form-control" id="detailDescription"></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" id="d-none d-sm-inline-block shadow-sm btn-update-product" class="btn btn-info">Cập nhật</button>
                            <input class="d-none d-sm-inline-block shadow-sm btn btn-primary" type="reset" value="Reset">
                        </form>
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->

        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright &copy; Your Website 2020</span>
                </div>
            </div>
        </footer>
        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<div class="modal fade" id="message">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body" style="text-align: center;">
            </div>

        </div>
    </div>
</div>

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- ckeditor-->
<script th:src="@{/ckeditor/ckeditor.js}"></script>

<!-- Bootstrap core JavaScript-->
<script th:src="@{/admin/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/admin/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{/admin/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages-->
<script th:src="@{/admin/js/sb-admin-2.min.js}"></script>

<!-- Page level plugins -->
<script th:src="@{/admin/vendor/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/admin/vendor/datatables/dataTables.bootstrap4.min.js}"></script>

<!-- Page level custom scripts -->
<script th:src="@{/admin/js/demo/datatables-demo.js}"></script>

<script th:inline="javascript">

    /*<![CDATA[*/
    $(document).ready(function () {
        let productId = /*[[${productId}]]*/;
        getListCategoryAndSupplier();
        getInfoProduct(productId);

        $("#btn-update-product").on("click", function (e) {
            e.preventDefault();
            let data = new FormData($("#formUpdateProduct")[0]);
            data.append("detailDescription", CKEDITOR.instances['detailDescription'].getData());
            // console.log(CKEDITOR.instances['detailDescription'].getData());
            $.ajax({
                url: "/api/admin/product/edit",
                data: data,
                type: "PUT",
                enctype: 'multipart/form-data',
                // prevent jQuery from automatically transforming the data into a query string
                processData: false,
                contentType: false,
                cache: false,
                timeout: 1000000,
                success: function (result) {
                    $("#btn-update-product").prop("disabled", false);
                    $('#formUpdateProduct')[0].reset();
                    $('#message').find("div.modal-body").text("Cập nhật sản phẩm thành công!!");
                    $('#message').modal('show');
                    $('#message').on('hidden.bs.modal', function () {
                        window.location.replace("/admin/manager_products");
                    });
                },
                error: function () {
                    alert("có lỗi xảy ra");
                }
            });
        });

        $("#category").change(function () {
            let parentCategoryId = $("#category option:selected").val();
            let categories = JSON.parse(localStorage.getItem("categories"));
            $.each(categories, function (index, item) {
                if (parseInt(parentCategoryId) === parseInt(item["id"])) {
                    $('#sub-category').empty();
                    if (item.hasOwnProperty("subCategory")) {
                        $.each(item["subCategory"], function (index, subItem) {
                            $('#sub-category').append(new Option(subItem["categoryName"], subItem["id"]));
                        });
                    } else {
                        $('#sub-category').append(new Option(item["categoryName"], item["id"]));
                    }
                    $('#sub-category > option:first-child').prop('selected', true);
                    return;
                }
            });

        });

        $("#btn-add-category-supplier").on("click", function () {
            $("#add-category-supplier").show();
            $("#select-category-supplier").hide();
        });

        function getListCategoryAndSupplier() {
            $.ajax({
                url: "/api/categories-suppliers",
                type: "GET",
                contentType: "application/json",
                success: function (data) {
                    // Put the object into storage
                    let categories = data["categories"];
                    let suppliers = data["suppliers"];
                    localStorage.setItem('categories', JSON.stringify(categories));

                    // show category
                    $('#category').empty();
                    $("#sub-category").empty();
                    $.each(categories, function (index, item) {
                        $('#category').append(new Option(item["categoryName"], item["id"]));
                        $('#add-category2').append(new Option(item["categoryName"], item["id"]));
                    });
                    $('#category > option:first-child').prop('selected', true);
                    $.each(categories[0]["subCategory"], function (index, item) {
                        $("#sub-category").append(new Option(item["categoryName"], item["id"]));
                    });
                    $('#sub-category > option:first-child').prop('selected', true);

                    // suppliers
                    $.each(suppliers, function (index, item) {
                        $('#supplier').append(new Option(item["name"], item["id"]));
                    });
                    $('#supplier > option:first-child').prop('selected', true);

                },
                error: function () {
                    alert("có lỗi xảy ra, không lấy được danh sách danh mục");
                }
            });
        }

        function removeAccents(str) {
            return str.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/đ/g, 'd').replace(/Đ/g, 'D');
        }

        function getInfoProduct(productId) {
            $.ajax({
                url: "/api/admin/product/view/" + productId,
                type: "GET",
                contentType: "application/json",
                success: function (data) {
                    //productName
                    $("#productId").val(data["id"]);
                    $("#productName").val(data["productName"]);
                    $("#category > option").each(function () {
                        if ($(this).text() === data["categoryName"]) {
                            $(this).prop('selected', true);
                        }
                    });
                    $("#sub-category > option").each(function () {
                        if ($(this).text() === data["categoryName"]) {
                            $(this).prop('selected', true);
                        }
                    });

                    $("#supplier > option").each(function () {
                        if ($(this).text() === data["supplierName"]) {
                            $(this).prop('selected', true);
                        }
                    });
                    $("#price").val(data["price"]);
                    $("#promotion").val(data["promotion"]);
                    $("#baseDescription").val(data["baseDescription"]);
                    CKEDITOR.replace('detailDescription');
                    CKEDITOR.instances['detailDescription'].setData( "<p>" + data["detailDescription"] + "</p>" );
                    // $("#detailDescription").val(data["detailDescription"]);
                    $("#output0").attr("src", data["mainImage"]);
                    if (data.hasOwnProperty("images")) {
                        let arrImages = data["images"];
                        for (let i = 0; i <= arrImages.length; i++) {
                            if (i==1) {
                                $("#output1").attr("src", arrImages[i]);
                            } else if (i == 2) {
                                $("#output2").attr("src", arrImages[i]);
                            } else if ( i == 3) {
                                $("#output3").attr("src", arrImages[i]);
                            }
                        }
                    }
                },
                error: function () {
                    alert("có lỗi xảy ra");
                }
            });
        }
    });

    let loadMainImage = function (event) {
        let output = document.getElementById('output0');
        output.src = URL.createObjectURL(event.target.files[0]);
        output.onload = function () {
            URL.revokeObjectURL(output.src) // free memory
        }
        output.style.display = "block";
    };

    let loadImage1 = function (event) {
        let output1 = document.getElementById('output1');
        output1.src = URL.createObjectURL(event.target.files[0]);
        output1.onload = function () {
            URL.revokeObjectURL(output1.src) // free memory
        }
        output1.style.display = "block";
    };

    let loadImage2 = function (event) {
        let output2 = document.getElementById('output2');
        output2.src = URL.createObjectURL(event.target.files[0]);
        output2.onload = function () {
            URL.revokeObjectURL(output2.src) // free memory
        }
        output2.style.display = "block";
    };

    let loadImage3 = function (event) {
        let output3 = document.getElementById('output3');
        output3.src = URL.createObjectURL(event.target.files[0]);
        output3.onload = function () {
            URL.revokeObjectURL(output3.src) // free memory
        }
        output3.style.display = "block";
    };
    /*]]>*/
</script>

</body>

</html>