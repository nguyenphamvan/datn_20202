<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<th:block th:include="admin/common/header"/>
<head>
    <title>Thêm sản phẩm mới</title>
</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Admin</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
            <a class="nav-link" th:href="@{/admin}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item active">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-cog"></i>
                <span>Quản lý</span>
            </a>
            <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" th:href="@{/admin/manager_users}"><i class="fas fa-users"></i> Quản lý người dùng</a>
                    <a class="collapse-item active" th:href="@{/admin/manager_products}"><i class="fab fa-product-hunt"></i> Quản lý sản phẩm</a>
                    <a class="collapse-item" th:href="@{/admin/manager_orders}"><i class="fas fa-shopping-basket"></i> Quản lý đơn hàng</a>
                    <a class="collapse-item" th:href="@{/admin/manager_promotions}"><i class="fa fa-gift"></i> Quản lý khuyến mãi</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" data-toggle="collapse" data-target="#collapseThree"
               aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-user-circle"></i>
                <span>Tài khoản</span>
            </a>
            <div id="collapseThree" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item"><i class="fas fa-users"></i>Cập nhật thông tin</a>
                    <form name="logoutForm" th:hidden="true" method="post" th:action="@{/admin/logout}">
                        <input type="submit" value="Logout" />
                    </form>
                    <a class="collapse-item" href="javascript: logoutForm.submit();"><i class="fab fa-product-hunt"></i> <span>Đăng xuất</span></a>
                </div>
            </div>
        </li>

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>

    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <!-- Sidebar Toggle (Topbar) -->
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>

                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span th:text="${#request.userPrincipal.principal.getFullName()}"
                                  class="mr-2 d-none d-lg-inline text-gray-600 small"></span>
                            <img class="img-profile rounded-circle" src="https://source.unsplash.com/QAB-WJcbgJk/60x60">
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- End of Topbar -->
            <!-- Begin Page Content -->
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-12">
                        <h4 style="text-align: center">Thêm sản phẩm mới</h4>
                    </div>
                    <div class="col-md-8">
                        <form id="addNewProduct" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="name">Tên sản phẩm:</label>
                                        <input type="text" class="form-control" placeholder="Nhập tên sản phẩm" id="name" name="name">
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="add-category-supplier" style="display: none;">
                                <div class="col-md-3">
                                    <label for="add-category">Danh mục</label>
                                    <div style="width: 100%; display: flex; justify-content: space-between;">
                                        <input type="text" class="form-control" placeholder="danh mục cha" id="add-category">
                                        <button type="button" id="btn-add-category" class="d-none d-sm-inline-block shadow-sm btn btn-primary">Thêm</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="add-category">Danh mục con</label>
                                    <div style="width: 100%; display: flex; justify-content: space-between;">
                                        <select class="form-control" id="add-category2" name="parentCategoryId">
                                        </select>
                                        <input type="text" class="form-control" placeholder="Tên danh mục con"
                                               id="add-sub-category">
                                        <button type="button" id="btn-add-sub-category" class="btn btn-primary">Thêm</button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="add-supplier">Tên nhà sản xuất</label>
                                    <div style="width: 100%; display: flex; justify-content: space-between;">
                                        <input type="text" min="0" class="form-control" id="add-supplier">
                                        <button type="button" id="btn-add-supplier" class="btn btn-primary">Thêm</button>
                                    </div>

                                </div>
                            </div>
                            <div class="row" id="select-category-supplier">
                                <div class="col-md-4">
                                    <label for="category">Danh mục cha</label>
                                    <select class="form-control" id="category" name="parentCategoryId">
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="sub-category">Danh mục con</label>
                                    <select class="form-control" id="sub-category" name="categoryId">
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="supplier">Nhà sản xuất:</label>
                                    <select class="form-control" id="supplier" name="supplierId">
                                    </select>
                                </div>
                                <div class="col-md-2 justify-content-end" style="position: relative;">
                                    <button type="button" style="position: absolute; bottom: 0;"
                                            class="btn btn-primary shadow-sm" id="btn-add-category-supplier">Thêm mới
                                    </button>
                                </div>
                            </div>
                            <br/>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="price">Giá bán (VNĐ)</label>
                                        <input type="number" class="form-control" placeholder="Nhập giá gốc" id="price"
                                               name="price">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="promotion">Giảm giá (VNĐ)</label>
                                        <input type="number" class="form-control" placeholder="giảm giá" id="promotion"
                                               name="promotion">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="imageUpload">Thêm ảnh chính:</label>
                                        <div class="custom-file">
                                            <input type="file" name="images" class="custom-file-input" id="imageUpload"
                                                   accept="image/*" onchange="loadFile(event)">
                                            <label class="custom-file-label" for="imageUpload">Choose file</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <img id="output" style="width: 100%; height: 150px;"/>
                                </div>
                            </div>

                            <!--                    <label>Thêm ảnh phụ</label>-->
                            <!--                    <div class="row">-->
                            <!--                        <div class="col-md-4">-->
                            <!--                            <label for="imageUpload1">ảnh 1</label>-->
                            <!--                            <div class="form-group">-->
                            <!--                                <div class="custom-file">-->
                            <!--                                    <input type="file" name="images" class="custom-file-input" id="imageUpload1"-->
                            <!--                                           accept="image/*" onchange="loadFile1(event)">-->
                            <!--                                    <label class="custom-file-label" for="imageUpload1">Choose file</label>-->
                            <!--                                </div>-->
                            <!--                                <img id="output1"-->
                            <!--                                     style="width: 100%; height: 150px; max-height: 200px; margin-top: 10px;"/>-->
                            <!--                            </div>-->
                            <!--                        </div>-->
                            <!--                        <div class="col-md-4">-->
                            <!--                            <label for="imageUpload2">ảnh 2</label>-->
                            <!--                            <div class="form-group">-->
                            <!--                                <div class="custom-file">-->
                            <!--                                    <input type="file" name="images" class="custom-file-input" id="imageUpload2"-->
                            <!--                                           accept="image/*" onchange="loadFile2(event)">-->
                            <!--                                    <label class="custom-file-label" for="imageUpload2">Choose file</label>-->
                            <!--                                </div>-->
                            <!--                                <img id="output2"-->
                            <!--                                     style="width: 100%; height: 150px; max-height: 200px; margin-top: 10px;"/>-->
                            <!--                            </div>-->
                            <!--                        </div>-->
                            <!--                        <div class="col-md-4">-->
                            <!--                            <label for="imageUpload3">ảnh 3</label>-->
                            <!--                            <div class="form-group">-->
                            <!--                                <div class="custom-file">-->
                            <!--                                    <input type="file" name="images" class="custom-file-input" id="imageUpload3"-->
                            <!--                                           accept="image/*" onchange="loadFile3(event)">-->
                            <!--                                    <label class="custom-file-label" for="imageUpload3">Choose file</label>-->
                            <!--                                </div>-->
                            <!--                                <img id="output3"-->
                            <!--                                     style="width: 100%; height: 150px; max-height: 200px; margin-top: 10px;"/>-->
                            <!--                            </div>-->
                            <!--                        </div>-->
                            <!--                    </div>-->

                            <!--                    <div class="row">-->
                            <!--                        <div class="col-md-12">-->
                            <!--                            <div class="form-group">-->
                            <!--                                <label for="baseDescription">Mô tả ngắn:</label>-->
                            <!--                                <input type="text" class="form-control" id="baseDescription" name="baseDescription">-->
                            <!--                            </div>-->
                            <!--                        </div>-->

                            <!--                    </div>-->

                            <!--                    <div class="row">-->
                            <!--                        <div class="col-md-12">-->
                            <!--                            <div class="form-group">-->
                            <!--                                <label for="detailDescription">Mô tả chi tiết:</label>-->
                            <!--                                <textarea rows="10" class="ckeditor form-control" id="detailDescription"-->
                            <!--                                          name="detailDescription"></textarea>-->
                            <!--                            </div>-->
                            <!--                        </div>-->
                            <!--                    </div>-->

                            <button type="button" class="d-none d-sm-inline-block shadow-sm btn btn-info" id="btn-add-product">Thêm</button>
                            <input class="d-none d-sm-inline-block shadow-sm btn btn-primary" type="reset" value="Reset">
                        </form>
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- Main Content -->
    </div>
</div>
<!-- End of Page Wrapper -->

<div class="modal fade" id="message">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body" style="text-align: center;">
            </div>

        </div>
    </div>
</div>

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- ckeditor-->
<script th:src="@{/ckeditor/ckeditor.js}"></script>

<!-- Bootstrap core JavaScript-->
<script th:src="@{/admin/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/admin/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript-->
<script th:src="@{/admin/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages-->
<script th:src="@{/admin/js/sb-admin-2.min.js}"></script>

<!-- Page level plugins -->
<script th:src="@{/admin/vendor/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/admin/vendor/datatables/dataTables.bootstrap4.min.js}"></script>

<!-- Page level custom scripts -->
<script th:src="@{/admin/js/demo/datatables-demo.js}"></script>

<script>

    getListCategoryAndSupplier();

    $("#btn-add-product").on("click", function (e) {
        e.preventDefault();
        let data = new FormData($("#addNewProduct")[0]);
        $.ajax({
            url: "/api/admin/product/add",
            data: data,
            type: "POST",
            enctype: 'multipart/form-data',
            // prevent jQuery from automatically transforming the data into a query string
            processData: false,
            contentType: false,
            cache: false,
            timeout: 1000000,
            success: function (result) {
                $("#btn-add-product").prop("disabled", false);
                $('#addNewProduct')[0].reset();
                $('#message').find("div.modal-body").text("Thêm sản phẩm thành công!")
                $('#message').modal('show');
                $('#message').on('hidden.bs.modal', function () {
                    window.location.replace("/admin/manager_products");
                });
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
    });

    $("#category").change(function () {
        let parentCategoryId = $("#category option:selected").val();
        let categories = JSON.parse(localStorage.getItem("categories"));
        $.each(categories, function (index, item) {
            if (parseInt(parentCategoryId) === parseInt(item["id"])) {
                $('#sub-category').empty();
                if (item.hasOwnProperty("subCategory")) {
                    $.each(item["subCategory"], function (index, subItem) {
                        $('#sub-category').append(new Option(subItem["categoryName"], subItem["id"]));
                    });
                } else {
                    $('#sub-category').append(new Option(item["categoryName"], item["id"]));
                }
                $('#sub-category > option:first-child').prop('selected', true);
                return;
            }
        });

    });

    $("#btn-add-category").on("click", function () {
        let categoryName = $("#add-category").val();
        alert(categoryName);
        $.ajax({
            url: "/api/categories/insert",
            type: "POST",
            data: JSON.stringify({
                "categoryName": categoryName,
                "categoryUrl": removeAccents(categoryName.toLowerCase()).replaceAll(" ", "-")
            }),
            contentType: "application/json",
            success: function (data) {
                getListCategoryAndSupplier();
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
        $("#add-category-supplier").hide();
        $("#select-category-supplier").show();

    });

    $("#btn-add-sub-category").on("click", function () {
        let parentId = $("#category option:selected").val();
        let categoryName = $("#add-sub-category").val();
        $.ajax({
            url: "/api/categories/insert",
            type: "POST",
            data: JSON.stringify({
                "parentId": parentId,
                "categoryName": categoryName,
                "categoryUrl": removeAccents(categoryName.toLowerCase()).replace(" ", "-")
            }),
            contentType: "application/json",
            success: function (data) {
                console.log(data);
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
        $("#add-category-supplier").hide();
        $("#select-category-supplier").show();
    });

    $("#btn-add-supplier").on("click", function () {
        let supplierName = $("#add-supplier").val();
        $.ajax({
            url: "/api/suppliers/insert",
            type: "POST",
            data: JSON.stringify({
                "name": supplierName
            }),
            contentType: "application/json",
            success: function (data) {
                getListCategoryAndSupplier();
                window.location = "/admin/manager_products";
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
        $("#add-category-supplier").hide();
        $("#select-category-supplier").show();

    });

    let loadFile = function (event) {
        let output = document.getElementById('output');
        output.src = URL.createObjectURL(event.target.files[0]);
        output.onload = function () {
            URL.revokeObjectURL(output.src) // free memory
        }
        output.style.display = "block";
    };

    // let loadFile1 = function (event) {
    //     let output1 = document.getElementById('output1');
    //     output1.src = URL.createObjectURL(event.target.files[0]);
    //     output1.onload = function () {
    //         URL.revokeObjectURL(output1.src) // free memory
    //     }
    //     output1.style.display = "block";
    // };
    //
    // let loadFile2 = function (event) {
    //     let output2 = document.getElementById('output2');
    //     output2.src = URL.createObjectURL(event.target.files[0]);
    //     output2.onload = function () {
    //         URL.revokeObjectURL(output2.src) // free memory
    //     }
    //     output2.style.display = "block";
    // };
    //
    // let loadFile3 = function (event) {
    //     let output3 = document.getElementById('output3');
    //     output3.src = URL.createObjectURL(event.target.files[0]);
    //     output3.onload = function () {
    //         URL.revokeObjectURL(output3.src) // free memory
    //     }
    //     output3.style.display = "block";
    // };

    $("#btn-add-category-supplier").on("click", function () {
        $("#add-category-supplier").show();
        $("#select-category-supplier").hide();
    });

    // function getListCategoryAndSupplier() {
    //     $.ajax({
    //         url: "/api/categories-suppliers",
    //         type: "GET",
    //         contentType: "application/json",
    //         success: function (data) {
    //             // Put the object into storage
    //             let categories = data["categories"];
    //             let suppliers = data["suppliers"];
    //             localStorage.setItem('categories', JSON.stringify(categories));
    //
    //             // show category
    //             $('#category').empty();
    //             $("#sub-category").empty();
    //             $.each(categories, function (index, item) {
    //                 $('#category').append(new Option(item["categoryName"], item["id"]));
    //                 $('#add-category2').append(new Option(item["categoryName"], item["id"]));
    //             });
    //             $('#category > option:first-child').prop('selected', true);
    //             $.each(categories[0]["subCategory"], function (index, item) {
    //                 $("#sub-category").append(new Option(item["categoryName"], item["id"]));
    //             });
    //             $('#sub-category > option:first-child').prop('selected', true);
    //
    //             // suppliers
    //             $.each(suppliers, function (index, item) {
    //                 $('#supplier').append(new Option(item["name"], item["id"]));
    //             });
    //             $('#supplier > option:first-child').prop('selected', true);
    //
    //         },
    //         error: function () {
    //             alert("có lỗi xảy ra, không lấy được danh sách danh mục");
    //         }
    //     });
    // }

    function removeAccents(str) {
        return str.normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }
</script>

</body>

</html>