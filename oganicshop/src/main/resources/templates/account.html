<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Tài khoản của tôi</title>
    <th:block th:include="common/header_tag_common"/>
    <!-- custom css  -->
    <link rel="stylesheet" th:href="@{/css/custom2.css}">
</head>
<body class="js">
<!-- Header -->
<th:block th:include="common/header"/>
<!--/ End Header -->

<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="bread-inner">
                    <ul class="bread-list">
                        <li><a th:href="@{/}">Trang chủ<i class="ti-arrow-right"></i></a></li>
                        <li class="active">Thông tin tài khoản</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Breadcrumbs -->

<!-- Product Style -->
<section class="product-area shop-sidebar shop section" style="padding-top: 15px;">
    <div class="container">
        <div class="row">
            <div class="Account__StyledSideBar">
                <div class="Account__StyledAvatar">
                    <img src="https://salt.tikicdn.com/desktop/img/avatar.png">
                    <div th:if="${#request.userPrincipal}" class="info">Tài khoản của<strong sec:authentication="principal.fullName"></strong></div>
                </div>
                <ul class="Account__StyledNav">
                    <li>
                        <a class="" href="/customer/account/edit">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                            </svg>
                            <span>Thông tin tài khoản</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/notification">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path>
                            </svg>
                            <span>Thông báo của tôi</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/sales/order/history">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 12h7v1.5h-7zm0-2.5h7V11h-7zm0 5h7V16h-7zM21 4H3c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 15h-9V6h9v13z"></path>
                            </svg>
                            <span>Quản lý đơn hàng</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/address">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"></path>
                            </svg>
                            <span>Địa chỉ giao hàng</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/nhan-xet-san-pham-ban-da-mua">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"></path>
                            </svg>
                            <span>Nhận xét sản phẩm đã mua</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/wishlist">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                            </svg>
                            <span>Sản phẩm yêu thích</span>
                        </a>
                    </li>
                    <li>
                        <a class="" href="/customer/review">
                            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                 height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4V6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"></path>
                            </svg>
                            <span>Nhận xét của tôi</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="Account__StyledAccountLayoutInner" id="customer_edit" style="display: none;">
                <div type="success" class="Alert__StyledAlert" style="display: none;">
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512"
                         color="#26BC4E" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"
                         style="color: rgb(38, 188, 78);">
                        <path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"></path>
                    </svg>
                    <span>Thông tin tài khoản của bạn đã được cập nhật.</span>
                </div>
                <h3 class="styles__StyledHeading">Thông tin tài khoản</h3><br/>
                <div class="inner div-form">
                    <form id="user_info">
                        <div class="div-form-control">
                            <label class="input-label">Họ tên</label>
                            <input class="form-control" type="text" name="fullName" maxlength="128">
                        </div>
                        <div class="div-form-control ">
                            <label class="input-label">Số điện thoại</label>
                            <input class="form-control" type="tel" name="phoneNumber"
                                   placeholder="Hãy nhập SĐT để trải nghiệm tốt hơn">
                        </div>
                        <div class="div-form-control">
                            <label class="input-label">Email</label>
                            <input class="form-control" type="email" name="email" disabled="">
                        </div>
                        <div class="div-form-control">
                            <label class="input-label">Giới tính</label>
                            <div style="margin-right: 50px;">
                                <input type="radio" name="gender" value="male" checked="">
                                <span style="margin-left: 10px;">Nam</span>
                            </div>
                            <div style="margin-right: 50px;">
                                <input type="radio" name="gender" value="female">
                                <span style="margin-left: 10px;">Nữ</span>
                            </div>
                        </div>
                        <div class="div-form-control">
                            <label class="input-label">Ngày sinh<span>(không bắt buộc)</span></label>
                            <input class="form-control" type="date" name="birthday">
                        </div>
                        <div class="div-form-control">
                            <label class="input-label">&nbsp;</label>
                            <label>
                                <input name="edit_password" type="checkbox">
                                <span class="checkbox-fake">Thay đổi mật khẩu</span>
                            </label>
                        </div>
                        <div id="input_group_password" style="display: none;">
                            <div class="div-form-control">
                                <label class="input-label">Mật khẩu cũ</label>
                                <div>
                                    <input class="form-control" type="password" required="true" name="oldPassword"
                                           placeholder="Nhập mật khẩu cũ" value="">
                                </div>
                            </div>
                            <div class="div-form-control">
                                <label class="input-label">Mật khẩu mới</label>
                                <div>
                                    <input class="form-control" type="password" required="true" name="password"
                                           placeholder="Mật khẩu từ 6 đến 32 ký tự" value="">
                                </div>
                            </div>
                            <div class="div-form-control">
                                <label class="input-label">Nhập lại</label>
                                <div>
                                    <input class="form-control" type="password" required="true" name="passwordConfirm"
                                           placeholder="Nhập lại mật khẩu mới" value="">
                                </div>
                            </div>
                        </div>
                        <div class="div-form-control">
                            <label class="input-label">&nbsp;</label>
                            <button id="button_submit_info" type="button" class="btn btn-submit">Cập nhật</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="Account__StyledAccountLayoutInner" id="customer_notification" style="display: none;">
                <div class="styles__StyledNotification">
                    <div class="heading">Thông báo của tôi</div>
                    <div class="inner">
                        <ul class="tabs">
                            <li class="is-active" title="Thông báo chung">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                     height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path>
                                </svg>
                            </li>
                            <li class="" title="Thông báo khuyến mãi">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                     height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"></path>
                                </svg>
                            </li>
                            <li class="" title="Thông báo đơn hàng">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                     height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 17H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V7h12v2zM3 22l1.5-1.5L6 22l1.5-1.5L9 22l1.5-1.5L12 22l1.5-1.5L15 22l1.5-1.5L18 22l1.5-1.5L21 22V2l-1.5 1.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v20z"></path>
                                </svg>
                            </li>
                            <li class="" title="Thông báo hệ thống">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                     height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79 2.73 2.71 7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12zM12.5 8v4.25l3.5 2.08-.72 1.21L11 13V8h1.5z"></path>
                                </svg>
                            </li>
                            <li class="last">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24"
                                     height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path>
                                </svg>
                            </li>
                        </ul>
                        <div class="list">
                            <div class="styles__StyledItem-sc-1ghyfo6-2 fGUCWl item">
                                <div class="date">04/01/2021</div>
                                <div class="content">Đơn hàng #521352150 đã sẵn sàng để giao đến quý khách. Chúng tôi
                                    vừa bàn giao đơn hàng của quý khách đến đối tác vận chuyển Tiki Team. Đơn hàng sẽ
                                    được giao trước 23:59 ngày 04/01/2021
                                    <a target="_blank" href="https://tiki.vn/sales/order/view?code=521352150">Chi
                                        tiết</a>
                                </div>
                                <button class="delete">Xóa</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!--/ End Product Style 1  -->

<!-- Start Footer Area -->
<th:block th:include="common/footer"/>
<!-- /End Footer Area -->

<script th:inline="javascript">
    /*<![CDATA[*/
    // A $( document ).ready() block.
    $(document).ready(function () {
        $(".Account__StyledSideBar").siblings().css('display', 'none');
        let pageURL = $(location).attr("href");
        if (pageURL.includes("/customer/account/edit")) {
            getInfoUser()
            $("#customer_edit").css('display', 'block');
        }

        if (pageURL.includes("/customer/notification")) {
            $("#customer_notification").css('display', 'block');
        }

        /* show hide block to edit password*/
        $("input[name='edit_password']").on("click", function () {
            if ($("input[name='edit_password']").is(':checked')) {
                $("#input_group_password").show();
            } else {
                $("#input_group_password").hide();
            }
        });

        $("#button_submit_info").on("click", function () {
            let data = {
                "email": $("input[name='email']").val(),
                "fullName": $("input[name='fullName']").val(),
                "gender": $("input[name='gender']").val(),
                "phone": $("input[name='phoneNumber']").val(),
                "birthday": $("input[name='birthday']").val()
            }
            $("div").removeClass("has-error");
            $(".error-message").remove();

            if ($("input[name='edit_password']").is(':checked')) {
                if (validatePassword() === true) {
                    data["password"] = $("input[name='password']").val();
                    updateInfo(data);
                }
                alert(data["password"]);
            } else {
                updateInfo(data);
            }
        });

        $(".Account__StyledNav > li > a").on('click', function () {
            $(this).addClass('is-active');
        });

        $(".Account__StyledNav > li").on('click', function () {
            $(this).addClass("is-active");
        });

        $(document).on('click', '.my-reviews__button', function (e) {
            e.preventDefault();
            $(".write-review__product img").attr("src", $(this).siblings(".my-reviews__info").find("img").attr("src"));
            $(".write-review__product-name").text($(this).siblings(".my-reviews__info").find(".my-reviews__name").text());
            $("input[name='orderDetail-id']").val($(this).siblings(".my-reviews__info").attr("orderDetail-id"));
            $("input[name='product-id']").val($(this).siblings(".my-reviews__info").attr("product-id"));
        });


    });

    function validatePassword() {
        let oldPassword = $("input[name='oldPassword']").val();
        let password = $("input[name='password']").val();
        let passwordConfirm = $("input[name='passwordConfirm']").val();
        let token = true;
        if (oldPassword.length === 0) {
            token = false;
            $("input[name='oldPassword']").closest("div.div-form-control").addClass("has-error");
            $("<div class=\"error-message\">Vui lòng nhập mật khẩu cũ</div>").insertAfter($("input[name='oldPassword']"));
        }

        if (password.length === 0) {
            token = false;
            $("input[name='password']").closest("div.div-form-control").addClass("has-error");
            $("<div class=\"error-message\">Vui lòng nhập mật khẩu mới</div>").insertAfter($("input[name='password']"));
        }

        if (passwordConfirm.length === 0) {
            token = false;
            $("input[name='passwordConfirm']").closest("div.div-form-control").addClass("has-error");
            $("<div class=\"error-message\">Bạn chưa xác nhận mật khẩu mới</div>").insertAfter($("input[name='passwordConfirm']"));
        }

        if (oldPassword.length > 0 && password.length > 0 && passwordConfirm.length > 0) {
            $.ajax({
                url: "/api/account/check-password?oldPassword=" + oldPassword,
                type: "GET",
                success: function (isMatch) {
                    if (isMatch === false) {
                        token = false;
                        $("input[name='oldPassword']").closest("div.div-form-control").addClass("has-error");
                        $("<div class=\"error-message\">Mật khẩu cũ không đúng</div>").insertAfter($("input[name='oldPassword']"));
                    }
                    if (password !== passwordConfirm) {
                        token = false;
                        $("input[name='passwordConfirm']").closest("div.div-form-control").addClass("has-error");
                        $("<div class=\"error-message\">Mật khẩu không trùng khớp</div>").insertAfter($("input[name='passwordConfirm']"));
                    }
                },
                error: function (xhr) {
                    alert("có lỗi xảy ra");
                }
            });
        }
        return token;
    }

    function getInfoUser() {
        $.ajax({
            url: "/api/account/info",
            type: "GET",
            dataType: 'json',
            success: function (user) {
                $("input[name='fullName']").val(user["fullName"]);
                $("input[name='phoneNumber']").val(user["phone"]);
                $("input[name='email']").val(user["email"]);
                $("input[name='birthday']").val(user["birthday"]);
                let $radios = $('input:radio[name=gender]');
                if (user["gender"] === "male") {
                    $radios.filter('[value=male]').prop('checked', true);
                } else {
                    $radios.filter('[value=female]').prop('checked', true);
                }
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
    }

    function updateInfo(data) {
        $.ajax({
            url: "/api/account/update",
            data: JSON.stringify(data),
            type: "PUT",
            dataType: 'json',
            contentType: "application/json",
            cache: false,
            success: function (user) {
                $("div.Alert__StyledAlert").css('display', 'block');
                $("input[name='fullName']").val(user["fullName"]);
                $("input[name='phoneNumber']").val(user["phone"]);
                $("input[name='email']").val(user["email"]);
                $("input[name='birthday']").val(user["birthday"]);
                let $radios = $('input:radio[name=gender]');
                if (user["gender"] === "male") {
                    $radios.filter('[value=male]').prop('checked', true);
                } else {
                    $radios.filter('[value=female]').prop('checked', true);
                }
            },
            error: function () {
                alert("có lỗi xảy ra");
            }
        });
    }

    function removeProductFromWishlist(buttonDelete, productId) {
        $.ajax({
            url: "/api/account/wishlist/remove/" + productId,
            type: "DELETE",
            dataType: 'json',
            success: function (result) {
                if (result === true) {
                    let heading = $(".styles__StyledAccountWishList .heading span");
                    heading.text(parseInt(heading.text()) - 1);
                    buttonDelete.closest("li.item").remove();
                }
            },
            error: function (err) {
                alert("có lỗi xảy ra");
            }
        });
    }

    /*]]>*/
</script>
</body>
</html>